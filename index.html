<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horarios Kushki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sticky-col { 
            position: sticky; left: 0; z-index: 45; 
            background-color: #d0dbf5 !important; border-right: 2px solid #a3a3a3; 
        }
        .bg-N { background-color: #1f2937; color: white; } 
        .bg-M { background-color: #fef3c7; color: #92400e; } 
        .bg-V { background-color: #e9d5ff; color: #581c87; } 
        .bg-L { background-color: #f3f4f6; color: #9ca3af; } 
        .bg-S { background-color: #d1fae5; color: #065f46; } 
        .bg-VAC { background-color: #06b6d4; color: white !important; }
        .bg-PM  { background-color: #2563eb; color: white !important; }
        .header-base { background-color: #d0dbf5; color: black; } 
        .header-weekend { background-color: #fff9c4 !important; }
        .header-holiday { background-color: #f4cccc !important; }
        .weekend-border { border-left: 1px solid #a3a3a3; border-right: 1px solid #a3a3a3; }
        th, td { border: 1px solid #a3a3a3; height: 28px; }
        .legend-table td { padding: 2px 6px; font-size: 10px; border: 1px solid #d1d5db; }
        .month-separator {
            background-color: #1e293b; color: #00c8b0;
            text-transform: uppercase; font-weight: 900;
            letter-spacing: 0.15em; border-top: 4px solid #a3a3a3;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-[1650px] mx-auto flex flex-col xl:flex-row gap-4 items-start">
        <div class="w-full xl:flex-1 bg-white shadow-xl rounded-lg overflow-hidden border border-gray-400">
            <div class="bg-gray-200 p-3 flex justify-between items-center border-b border-gray-400">
                 <img src="https://cdn.prod.website-files.com/610d48b11166645391515201/610d494924c5b6515664155d_Logo_Kushki_Color.svg" class="h-8">
                 <div class="text-right text-[10px] font-bold text-gray-700 uppercase leading-tight">
                     Área de Infraestructura-Monitoreo<br>Rock - Monitoreo y Soporte
                 </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse text-[10px] table-fixed">
                    <tbody id="tabla-body"></tbody>
                </table>
            </div>
        </div>

        <div class="w-full xl:w-[280px] flex flex-col gap-3 shrink-0">
            <div class="bg-white shadow border border-gray-400 rounded">
                <div class="bg-gray-50 p-1.5 text-center font-bold text-[10px] border-b border-gray-400">JORNADAS</div>
                <table class="w-full legend-table">
                    <tr><td class="font-bold w-6 text-center">N</td><td>Nocturna (00:00-08:00)</td></tr>
                    <tr><td class="font-bold w-6 text-center">M</td><td>Matutina (08:00-16:00)</td></tr>
                    <tr><td class="font-bold w-6 text-center">V</td><td>Vespertina (16:00-00:00)</td></tr>
                    <tr><td class="font-bold w-6 text-center text-gray-400">L</td><td>Libre</td></tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        async function cargarHorario() {
            const URL = 'https://n8nprod01.kushki.dev:5678/webhook/RMT-Schedules?t=' + Date.now();
            const FERIADOS = [16, 17]; 

            try {
                const res = await fetch(URL);
                const data = await res.json();
                const tbody = document.getElementById('tabla-body');
                tbody.innerHTML = "";

                let weekendIdx = [];
                let headerItem = data.horario_final.find(i => i.tipo === 'HEADER_DIAS');

                // Función para generar las filas de números y letras de días
                const generarHeaderDias = () => {
                    if (!headerItem) return "";
                    let filaNum = `<tr><th class="sticky-col w-[110px] min-w-[110px] p-1 font-bold">COLABORADOR</th>`;
                    let filaLet = `<tr><th class="header-base border-r-2 border-gray-500"></th>`;
                    
                    headerItem.dias.forEach((d, i) => {
                        if (d === 'S' || d === 'D') weekendIdx.push(i);
                        let cls = (d === 'S' || d === 'D') ? "header-weekend" : "header-base";
                        if (FERIADOS.includes(i + 1)) cls = "header-holiday";
                        filaNum += `<th class="${cls} w-8 text-center font-bold border-b">${i + 1}</th>`;
                        filaLet += `<th class="${cls} w-8 text-center font-bold border-b-2 border-gray-500">${d}</th>`;
                    });
                    return filaNum + "</tr>" + filaLet + "</tr>";
                };

                // Corregir título inicial si es "APELLIDO"
                let mesInicial = data.titulo_mes === "APELLIDO" ? "FEBRUARY 2026" : data.titulo_mes;
                
                // Renderizado Inicial
                tbody.innerHTML += `<tr><th colspan="32" class="header-base p-2 text-xs font-black uppercase text-center border-b-2 border-gray-500">${mesInicial}</th></tr>`;
                tbody.innerHTML += generarHeaderDias();

                // Recorrer el JSON
                data.horario_final.forEach(item => {
                    if (item.tipo === 'CAMBIO_MES') {
                        // Insertar separador de mes + NUEVA CABECERA DE DÍAS
                        tbody.innerHTML += `<tr><td colspan="32" class="month-separator p-2 text-center">${item.titulo}</td></tr>`;
                        tbody.innerHTML += generarHeaderDias();
                    } else if (item.tipo === 'EMPLEADO') {
                        let fila = `<tr><td class="sticky-col p-1 font-bold text-[9px] truncate">${item.nombre}</td>`;
                        item.turnos.forEach((t, i) => {
                            let bg = "bg-white", txt = "text-gray-500", val = t;
                            const masks = { 'PM':'bg-PM', 'VAC':'bg-VAC' };
                            
                            if(masks[t]) { val = 'L'; bg = masks[t]; txt = "text-white font-bold"; }
                            else if(t === 'N') { bg = "bg-N"; txt = "text-white font-bold"; }
                            else if(t === 'M') { bg = "bg-M"; txt = "text-[#92400e] font-bold"; }
                            else if(t === 'V') { bg = "bg-V"; txt = "text-[#581c87] font-bold"; }
                            else if(t === 'S') { bg = "bg-S"; txt = "text-[#065f46] font-bold"; }
                            else if(weekendIdx.includes(i)) { bg = "header-weekend"; txt = "text-black font-bold"; }

                            fila += `<td class="text-center w-8 ${bg} ${txt} ${weekendIdx.includes(i) ? 'weekend-border' : ''}">${val}</td>`;
                        });
                        tbody.innerHTML += fila + "</tr>";
                    }
                });
            } catch (e) { console.error("Error cargando el horario:", e); }
        }
        cargarHorario();
    </script>
</body>
</html>
