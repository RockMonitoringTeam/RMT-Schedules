data.horario_final.forEach(item => {
    // NUEVO: Detectar cambio de mes y crear una fila separadora
    if (item.tipo === 'CAMBIO_MES') {
        let filaMes = `
            <tr class="bg-gray-800 text-white font-bold">
                <td colspan="100%" class="p-3 text-center text-sm uppercase tracking-widest border-t-4 border-gray-600">
                    ${item.titulo}
                </td>
            </tr>`;
        tbody.innerHTML += filaMes;
    }

    if (item.tipo === 'EMPLEADO') {
        let fila = `<tr><td class="p-1 font-bold sticky-col header-base w-[90px] min-w-[90px] max-w-[90px] whitespace-normal z-40 shadow-sm text-left text-[10px] leading-tight break-words">${item.nombre}</td>`;
        
        item.turnos.forEach((turno, index) => {
            let colorClass = "bg-white"; 
            let fontClass = "font-medium text-gray-500"; 
            let textoCelda = turno; 

            // ... (Toda tu lógica de colores de turnos actual se mantiene igual aquí abajo)
            if (turno === 'PM') { textoCelda = 'L'; colorClass = "bg-PM"; fontClass = "font-bold text-white"; }
            // ... resto de ifs (VAC, PL, BF, etc.)
            
            // Lógica de Fines de semana y Feriados
            if (weekendIndices.includes(index)) {
                fontClass += " weekend-border";
                if (!colorClass.startsWith('bg-')) {
                    colorClass = "header-weekend";
                    fontClass = "font-extrabold text-black weekend-border";
                }
            }
            // ... (Continuar con la lógica de N, M, V, S que ya tienes)

            fila += `<td class="p-1 text-center text-[10px] ${colorClass} ${fontClass}">${textoCelda}</td>`;
        });
        fila += `</tr>`;
        tbody.innerHTML += fila;
    }
});
